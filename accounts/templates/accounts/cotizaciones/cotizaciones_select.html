{% extends 'accounts/base_dashboard.html' %}
{% load static %}
{% block title %}Elejir cliente para cotizacion{% endblock %}
{% block header %}Elejir cliente para cotizacion{% endblock %}
{% block content %}
<!-- TITULO Y FORMULARIO -->
<div class="container mt-4">
  <h1 class="text-center">Cliente para cotización</h1>
  <hr />
  <form id="main-form" action="{% url 'cotizacion_asignation' %}" method="POST">
    {% csrf_token %}

    <!-- SELECT DE PROSPECTO -->
    <div class="form-group" >
      <h2>Prospecto</h2>
      <p>Selecciona un prospecto o crea uno.</p>
      <select name="persona" id="persona-select " class="form-control" onchange="mostrarFormularioNuevoProspecto()">
        <option value="" selected>Selecciona una persona</option>
        {% for persona in personas %}
        <option value="{{ persona.id }}">{{ persona.empresa.nombre_empresa }} | {{ persona }}</option>
        {% endfor %}
        <option value="nuevo">Crear nuevo prospecto</option>
      </select>
    </div>

    <br>
    <!-- FORMULARIOS DE NUEVO PROSPECTO -->
    <div id="nuevo_prospecto_form" style="display: none;">
      <hr /><br>
      <div class="row">
        <!-- COLUMNA DE PROSPECTO -->
        <div class="col-md-6">
          <h2>Datos del Prospecto</h2>
          <p>Ingresa los datos solicitados para poder registrar el usuario.</p>
          {{ persona_form.as_p }}
          {{ informacion_contacto_form.as_p }}
        </div>

        <!-- COLUMNA DE EMPRESA Y DIRECCIÓN -->
        <div class="col-md-6">
          <h2>Datos de la Empresa</h2>
          {{ empresa_form.as_p }}
          {{ direccion_form.as_p }}
        </div>
      </div>
    </div>

    <!-- BOTONES ACEPTAR Y CANCELAR -->
    <div class="form-group text-right mt-3">
      <input type="submit" class="btn btn-primary" value="Siguiente" />
      <input type="button" class="btn btn-danger" value="Cancelar" onclick="location.href='{% url 'cotizaciones_list' %}'" />
    </div>
  </form>
</div>

<script>
  function mostrarFormularioNuevoProspecto() {
    var select = document.getElementById('persona-select');
    var nuevoProspectoForm = document.getElementById('nuevo_prospecto_form');
    if (select.value === 'nuevo') {
      nuevoProspectoForm.style.display = 'block';
      deshabilitarCampos(false);
    } else {
      nuevoProspectoForm.style.display = 'none';
      deshabilitarCampos(true);
    }
  };

  function deshabilitarCampos(deshabilitar) {
    var form = document.getElementById('nuevo_prospecto_form');
    var inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(function(input) {
      input.disabled = deshabilitar;
    });
  }

  document.getElementById('main-form').addEventListener('submit', function(event) {
    var select = document.getElementById('persona-select');
    if (select.value === '') {
      alert('Por favor selecciona un prospecto o crea uno nuevo.');
      event.preventDefault();
    }
  });

  // Inicializar deshabilitando los campos
  deshabilitarCampos(true);
</script>
{% endblock %}
